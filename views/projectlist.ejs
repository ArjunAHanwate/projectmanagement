<% include ./partians/header %>

<div class="flex flex-col md:flex-row h-screen">

    <!-- Sidebar -->
    <div class="w-full md:w-20 h-auto md:h-screen flex flex-col items-center md:justify-center bg-gray-200 md:bg-white fixed bottom-0 left-0 md:relative z-10 md:z-auto">
        <div class="flex md:block justify-around w-full md:w-auto py-2 md:py-0">
            <a href="/profile" id="profile-link">
                <img id="profile-img" class="my-2 md:my-10 w-12 md:w-auto" src="/images/Dashboard.png" alt="Dashboard">
            </a>
            <a href="/projectlist" id="projectlist-link">
                <img id="projectlist-img" class="my-2 md:my-10 w-12 md:w-auto" src="/images/Project-list.png" alt="Project List">
            </a>
            <a href="/addproject" id="addproject-link">
                <img id="addproject-img" class="my-2 md:my-10 w-12 md:w-auto" src="/images/create-project.png" alt="Create Project">
            </a>
            <a href="/logout" id="logout-link">
                <img id="logout-img" class="my-2 md:my-10 w-12 md:w-auto" src="/images/Logout.png" alt="Logout">
            </a>
        </div>
    </div>

    <!-- Main content -->
    <div class="w-full  md:flex-1">
        <div class="w-full h-32 flex px-4 flex items-center justify-between rounded-bl-[50px] relative" id="bg">
            <div class="flex  items-center justify-between ">
                <p class="text-2xl text-white font-semibold">Project List</p>
                <div class="flex-1 w-full z-0 items-center absolute justify-center flex" id="image">
                    <img src="/images/Logo.svg" alt="" class="h-16">
                </div>
            </div> 
        </div> 

        <div class="w-full rounded-[30px]  bg-[#f0f0f0] h-[85vh] pt-2 ">
            <div class="flex justify-between px-10">
                <input type="text" class="p-2 rounded-md" name="search" placeholder="Search" id="searchInput" value="<%= searchQuery %>">
                <div>
                    <label for="sort">Sort by:</label>
                    <select class="p-2 w-36 h-11 mx-2 rounded-md" name="sort" id="sort">
                        <option value="priority" <%= sortQuery === 'priority' ? 'selected' : '' %>>Priority</option>
                        <option value="category" <%= sortQuery === 'category' ? 'selected' : '' %>>Category</option>
                        <option value="reason" <%= sortQuery === 'reason' ? 'selected' : '' %>>Reason</option>
                        <option value="division" <%= sortQuery === 'division' ? 'selected' : '' %>>Division</option>
                        <option value="department" <%= sortQuery === 'department' ? 'selected' : '' %>>Department</option>
                        <option value="location" <%= sortQuery === 'location' ? 'selected' : '' %>>Location</option>
                    </select>
                    
                </div>
            </div>

            <div class="pt-5">
                <div class="w-full bg-blue-100 h-11 flex">
                    <div class="w-72 flex items-center px-8 h-11">
                        <p class="font-semibold">Project Name</p>
                    </div>
                    <div class="flex font-semibold h-11 w-3/5 p-2 items-center">
                        <p class="w-32">Reason</p>
                        <p class="w-32">Type</p>
                        <p class="w-32">Division</p>
                        <p class="w-32">Category</p>
                        <p class="w-32">Priority</p>
                        <p class="w-36">Dept.</p>
                        <p class="w-32">Location</p>
                        <p class="w-32">Status</p>
                    </div>
                    <div></div>
                </div>

                <div class="">
                    <% projects.forEach(projectData => { %>
                        <div class="w-full h-20 flex">
                            <div class="w-72 p-2 items-center flex px-8 h-11">
                                <div class="pt-8">
                                    <p class="font-semibold"><%= projectData.theme %></p>
                                    <p><%= projectData.startDate %> to <%= projectData.endDate %></p>
                                </div>
                            </div>
                            <div class="flex w-[800px] p-2 items-center">
                                <p class="w-32 text-zinc-700"><%= projectData.reason %></p>
                                <p class="w-32 text-zinc-700"><%= projectData.type %></p>
                                <p class="w-32 text-zinc-700"><%= projectData.decision %></p>
                                <p class="w-32 text-zinc-700"><%= projectData.category %></p>
                                <p class="w-32 text-zinc-700"><%= projectData.priority %></p>
                                <p class="w-36 text-zinc-700"><%= projectData.department %></p>
                                <p class="w-32 text-zinc-700"><%= projectData.location %></p>
                                <p class="w-32 text-zinc-700 font-semibold" id="status-<%= projectData._id %>"><%= projectData.status ? projectData.status : 'Registered' %></p>
                            </div>
                            <div class="w-60 h-full flex items-center justify-start">
                                <input class="w-32 h-8 border border-blue-500 rounded-full font-semibold mx-2 text-blue-500" type="button" value="Start" onclick="updateState('<%= projectData._id %>', 'Running')">
                                <input class="w-32 h-8 border border-blue-500 rounded-full font-semibold mx-2 text-blue-500" type="button" value="Close" onclick="updateState('<%= projectData._id %>', 'Closed')">
                                <input class="w-32 h-8 border border-blue-500 rounded-full font-semibold mx-2 text-blue-500" type="button" value="Cancel" onclick="updateState('<%= projectData._id %>', 'Cancelled')">
                            </div>
                            <div></div>
                        </div>
                        <hr class="border-t-1 border-black">
                    <% }); %>
                </div>

                <!-- Pagination -->
                <div class="flex justify-center my-4">
                    <% if (currentPage > 1) { %>
                        <a href="/projectlist?page=<%= currentPage - 1 %>&search=<%= searchQuery %>&sort=<%= sortQuery %>" class="mx-2 px-4 py-2 text-blue-500  text-blue-500 rounded">&larr;</a>
                    <% } %>
                    <% for (let i = 1; i <= totalPages; i++) { %>
                        <a href="/projectlist?page=<%= i %>&search=<%= searchQuery %>&sort=<%= sortQuery %>" class="mx-1 px-3 py-2 <%= i === currentPage ?  'text-blue-500' : 'text-blue-500' %> rounded"><%= i %></a>
                    <% } %>
                    <% if (currentPage < totalPages) { %>
                        <a href="/projectlist?page=<%= currentPage + 1 %>&search=<%= searchQuery %>&sort=<%= sortQuery %>" class="mx-2 px-4 py-2  text-blue-500 rounded">&rarr;</a>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function updateState(projectId, newState) {
        document.getElementById('status-' + projectId).innerHTML = newState;
        fetch('/update-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ _id: projectId, status: newState })
        }).then(response => {
            if (response.ok) {
                console.log('Status updated successfully');
            } else {
                console.error('Error updating status');
            }
        }).catch(error => {
            console.error('Error:', error);
        });
    }

    document.getElementById('searchInput').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            const searchValue = this.value;
            window.location.href = `/projectlist?search=${searchValue}`;
        }
    });

    function handleSearchAndSort() {
        const searchValue = document.getElementById('searchInput').value.trim(); 
        const sortValue = document.getElementById('sort').value;
        const url = `/projectlist?search=${searchValue}&sort=${sortValue}`;
        window.history.replaceState(null, null, url); 
    }
    document.getElementById('sort').addEventListener('change', handleSearchAndSort);
    
    function updateImages() {
        const path = window.location.pathname;
        
        const images = {
            profile: '/images/Dashboard.png',
            projectlist: '/images/Project-list.png',
            addproject: '/images/create-project.png',
            logout: '/images/Logout.png'
        };

        const activeImages = {
            profile: '/images/Dashboard-active.png',
            projectlist: '/images/Project-list-active.png',
            addproject: '/images/create-project-active.png',
            logout: '/images/Logout-active.png'
        };

        const pathToIdMap = {
            '/profile': 'profile-img',
            '/projectlist': 'projectlist-img',
            '/addproject': 'addproject-img',
            '/logout': 'logout-img'
        };

        for (const [key, value] of Object.entries(pathToIdMap)) {
            const imgElement = document.getElementById(value);
            if (key === path) {
                imgElement.src = activeImages[value.split('-')[0]];
            } else {
                imgElement.src = images[value.split('-')[0]];
            }
        }
    }

    window.onload = updateImages;
</script>

<% include ./partians/footer %>
